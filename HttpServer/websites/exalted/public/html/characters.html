<div class="container">
	<div class="card" style="margin-top: 20px;">
		<div class="card-body">
			<h4 class="card-title">Characters</h4>
			<ul class="list-group ">
				<div id="charactersContainer">
				</div>
			</ul>	
		</div>
		
		<div class="card-footer text-muted">
			<button type="button" class="btn btn-primary" data-toggle="modal" data-target="#createNewCharacter">Create New Character</button>
		</div>
	</div>
</div>

<div id="modalContainer">

</div>

	<!-- Modal -->
	<div class="modal fade" id="createNewCharacter" tabindex="-1" role="dialog" aria-labelledby="createNewCharacterLabel" aria-hidden="true">
		<div class="modal-dialog" role="document">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title" id="createNewCharacterLabel">Create New Character</h5>
					<button type="button" class="close" data-dismiss="modal" aria-label="Close">
						<span aria-hidden="true">&times;</span>
					</button>
				</div>
				<div class="modal-body">
					<form id="createNewCharacterForm">
						<div class="form-group">
							<label for="characterName">Character Name</label>
							<input type="text" class="form-control" name="charactername" placeholder="Enter Character Name">
						</div>
						<button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
						<button type="button" class="btn btn-primary float-right" onclick="createNewCharacter()" data-dismiss="modal">Create</button>
					</form>
				</div>
			</div>
		</div>
	</div>

<script>

function createNewCharacter()
{
	var formData = $("#createNewCharacterForm").serializeArray()
	var formDataJson = {};

	$.each(formData,
	function(i, v) {
		formDataJson[v.name] = v.value;
	});


	console.log(formDataJson)

	//Create
	sendHttpPostRequest("./api/character/create", JSON.stringify(formDataJson), () => 
	{
	
		//Refresh
		location.reload();	
	});


}

function deleteCharacter(id)
{
	// TODO delete and call refresh
	sendHttpPostRequest("./api/character/" + id + "/delete", null , () => {
		//Refresh
		location.reload();
	})
}

function viewCharacterSheet(id)
{
	// TODO navigate to character sheet
}

function sendHttpGetRequest(theUrl, callback)
{
	var xmlHttp = new XMLHttpRequest();
	xmlHttp.onreadystatechange = function() { 
		if (xmlHttp.readyState == XMLHttpRequest.DONE && xmlHttp.status == 200){
			callback(xmlHttp.responseText);
		}
	}

	xmlHttp.open("GET", theUrl, true); // true for asynchronous 
	xmlHttp.send(null);
}

function sendHttpPostRequest(theUrl, data, callback)
{
	var xmlHttp = new XMLHttpRequest();
	
		xmlHttp.onreadystatechange = function() { 
			if (xmlHttp.readyState == XMLHttpRequest.DONE && xmlHttp.status == 200){
				callback(xmlHttp.responseText);
			}
		}

	xmlHttp.open("POST", theUrl, true);

	xmlHttp.setRequestHeader("Content-Type", "application/json");

	xmlHttp.send(data)


}

function htmlEntities(str) 
{
    return String(str).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
}

sendHttpGetRequest("./api/characters", function(response) 
{
	var characterRowTemplate = `
		<li class="list-group-item">
			__CHARACTER_NAME__ 
			<div class="float-right">
				<button type="button" class="btn btn-primary" data-toggle="modal" data-target="#deleteConfirmation__CHARACTER_ID__">
					Delete
				</button>
				<button onclick="viewCharacterSheet('__CHARACTER_ID__')" class="btn btn-primary">View sheet</button>
			</div>
		</li>`;
	
	var modalTemplate = `
	<div class="modal fade" id="deleteConfirmation__CHARACTER_ID__" tabindex="-1" role="dialog" aria-labelledby="deleteConfirmationTitle" aria-hidden="true">
		<div class="modal-dialog modal-dialog-centered" role="document">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title" id="deleteConfirmationTitle">Are you sure you want to delete "__CHARACTER_NAME__" ?</h5>
					<button type="button" class="close" data-dismiss="modal" aria-label="Close">
						<span aria-hidden="true">&times;</span>
					</button>
				</div>
				<div class="modal-body">
				This is permanent
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
					<button type="button" class="btn btn-primary" onclick="deleteCharacter(__CHARACTER_ID__)">Yes</button>
				</div>
			</div>

		</div>
	</div>
	`;

	var charactersContainer = document.getElementById("charactersContainer");
	var modalContainer = document.getElementById("modalContainer");

	var characters = JSON.parse(response);

	for(var i = 0; i < characters.length; i++)
	{
		var character = characters[i];

		var rowToDisplay = characterRowTemplate.split("__CHARACTER_ID__").join(character.id);
		rowToDisplay = rowToDisplay.split("__CHARACTER_NAME__").join(character.name);


		charactersContainer.innerHTML = charactersContainer.innerHTML  + rowToDisplay;
		
		var modalToAdd = modalTemplate.split("__CHARACTER_ID__").join(character.id);
		modalToAdd = modalToAdd.split("__CHARACTER_NAME__").join(character.name);

		modalContainer.innerHTML = modalContainer.innerHTML + modalToAdd;
	}
});

</script>
