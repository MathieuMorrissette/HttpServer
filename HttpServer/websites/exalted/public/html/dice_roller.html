<div class="">
      <div class="card shadow">
			<h4 class="card-header">Dice Roller 2000</h4>
            <div class="card-body">
                  <div class="row">
                        <div class="col-md-4">
                              <label>Dice Count</label>
                              <input type="input" class="form-control" value="0" id="diceCount">
                        </div>
                        <div class="col-md-4">
                              <label for="">Dice Type</label>
                              <select id="" class="form-control">
                                    <option selected>10</option>
                              </select>
                        </div>
                        <div class="col-md-4 text-center align-self-end mt-1">
                              <span class="align-bottom"><button onclick="rollDicesbroken()" class="btn btn-primary">Roll!</button></span>
                        </div>
                  </div>

                  <div class="row">
                        <div class="col-md-4">
                              <label>Count Success From :</label>
                              <input type="input" class="form-control" value="7" id="successFrom">
                        </div>
                        <div class="col-md-8 align-self-center">
                              <label for="" data-toggle="tooltip" data-placement="bottom" title="Double every dice from">Doubles</label>
                              <select id="doubleValue" class="form-control">
                                    <option value="999">None</option>
                                    <option>2</option>
                                    <option>3</option>
                                    <option>4</option>
                                    <option>5</option>
                                    <option>6</option>
                                    <option>7</option>
                                    <option>8</option>
                                    <option>9</option>
                                    <option selected>10</option>
                              </select>
                        </div>
                  </div>

                  <div class="row">
                        <div class="col-md-4 align-self-center">
                              <label>Special Dice 10 Reroll  :</label><br>
                              <div class="custom-control custom-radio custom-control-inline">
                                    <input type="radio" id="specialReroll1" name="specialRerollRadio" class="custom-control-input" checked>
                                    <label class="custom-control-label" for="specialReroll1">None</label>
                              </div>
                              <div class="custom-control custom-radio custom-control-inline" data-toggle="tooltip" data-placement="bottom" title="Reroll 10's up to a maximum of non success dices">
                                    <input type="radio" id="specialReroll2" name="specialRerollRadio" class="custom-control-input" value="cascading">
                                    <label class="custom-control-label" for="specialReroll2">Non-Successes</label>
                              </div>
                        </div>
                        <div class="col-md-8 ">
                              <div class="row border m-3 p-2">
                                    <div class="col-12">
                                          <form id="reroll">
                                                <div class="row" id="reroll__ID__">
                                                      <div class="col-4">
                                                            <label>Reroll Dice :</label>
                                                            <input type="input" class="form-control" name="reroll__ID__-value" value="0">
                                                      </div>
                                                      <div class="col-4">
                                                            <label for="reroll__ID__" data-toggle="tooltip" data-placement="bottom" title="Roll until no more">Recusive :</label><br>
                                                            <input id="reroll__ID__" name="reroll__ID__-recursive" type="checkbox" onchange="setControlStates()">
                                                      </div>
                                                      <div class="col-4 align-self-center">
                                                            <button type="button" class="btn btn-primary float-right" onclick="deleteRow('reroll__ID__');"><i class="fas fa-trash-alt"></i></button>
                                                      </div>
                                                </div>
                                          </form>
                                    </div>
                              </div>
                              <div class="row">
                                    <div class="col-12">
                                          <button type="button" class="btn btn-primary float-right" onclick="addReRollDiceRow();">Add</button>
                                    </div>
                              </div>
                        </div>
                  </div>

                  <div class="row border p-2 mt-1">
                              <div id="successes" class="col-md-12 text-center" hidden>
                                    <h4>Successes : </h4><span id="successesResult" style="font-weight: bold;font-size:2em;"></span>
                              </div>
                  </div>

                  <div id="diceContainer">


                  </div>

            </div>
      </div>
</div>

<script>

      var rerollFields = {
            "fields" : [
                  {
                        "name" : "value",
                        "type" : "input"
                  },
                  {
                        "name" : "recursive",
                        "type" : "checkbox"
                  },

            ]
      }

      var results = [];
      var countJSON = [];

      var type = 10;

      var successes = 0;

      function rollDicesbroken() {
            results = []

            diceCountElem = document.getElementById("diceCount");

            diceCount = parseInt(diceCountElem.value)

            successFromElem = document.getElementById("successFrom");

            successFrom = parseInt(successFromElem.value);

            doubleValueElements = document.getElementById("doubleValue")

            doubleValue = null;

            doubleValue = parseInt(doubleValueElements.value);

            if (isNaN(successFrom)) {
                  return;
            }

            if (isNaN(diceCount)) {
                  return;
            }

            countJSON = rollDices(diceCount, 10);


            ShowRoll(countJSON, "First Roll!", true);

            // calculate successes
            successes = getSuccesses(countJSON, successFrom, doubleValue)

            UpdateSuccesses(successes)



           special10RollElements = document.getElementsByName("specialRerollRadio")

           rerollSpecial10 = null

           special10RollElements.forEach(element => {

                  if(element.checked)
                  {
                        rerollSpecial10 = element.value;
                  }
            });

            if(rerollSpecial10 == "cascading")
            {
                  reroll10LimitNonSuccess(successFrom, doubleValue);
            }
      }


      function reroll10LimitNonSuccess(successFrom, doubleFrom)
      {
            tenDicesCountElements = countJSON.filter(elem => { return elem["value"] == 10})

            if(tenDicesCountElements == null || tenDicesCountElements.length == 0)
            {
                  return;
            }

            tenDicesCount = tenDicesCountElements[0]["count"]

            nonSuccessesCount = 0      

            countJSON.forEach(diceValue => {
                  if(diceValue["value"] < successFrom)
                  {

                        nonSuccessesCount = nonSuccessesCount + diceValue["count"];
                  }
            });

            dicesToRoll = tenDicesCount;

            if(tenDicesCount > nonSuccessesCount)
            {
                  dicesToRoll = nonSuccessesCount;
            }

            newDiceCount = rollDices(dicesToRoll, 10);

            ShowRoll(newDiceCount, "Dice 10 Special Reroll",false);

            successes = successes + getSuccesses(newDiceCount,successFrom,doubleFrom)

            UpdateSuccesses(successes)

      }


      function ClearRolls()
      {
            diceContainerElem = document.getElementById("diceContainer");

            diceContainerElem.innerHTML = "";
      }

      function ShowRoll(diceCount, label, clear)
      {
            if(clear)
            {
                  ClearRolls();
            }

            diceHeader = `<div class="row mt-3">
                              <div class="col-12" >
                                    <div class="card shadow">
                                          <h4 class="card-header">` + label + `</h4>`  + `<div class="card-body">`

            diceTemplate = `
            
                        <div class="row">
                              <div class="col-12">
                                    <b>Dice Value :</b> __DICE_VALUE__ <b>Count :</b> __DICE_COUNT__
                              </div>
                        </div>
                 
            `;

            diceFooter = `</div></div></div></div></div>`;

            diceContainerElem = document.getElementById("diceContainer");


            htmlToAdd = diceHeader;

            diceCount.forEach(item => {
                  var tmp = diceTemplate.split("__DICE_VALUE__").join(item["value"]);
                  tmp = tmp.split("__DICE_COUNT__").join(item["count"]);

                  htmlToAdd = htmlToAdd + tmp;
            });

            diceContainerElem.innerHTML = diceContainerElem.innerHTML + htmlToAdd + diceFooter;
      }


      function UpdateSuccesses(successes)
      {
            successesElem = document.getElementById("successes")
            successesElem.hidden = false;

            successResult = document.getElementById("successesResult")

            successResult.innerHTML = " " + successes;
      }

      function getSuccesses(diceCount, successFrom, doubleFrom)
      {
             // calculate successes
             successes = 0;

             diceCount.forEach(diceValue => {
                  if(diceValue["value"] >= successFrom)
                  {
                        multiplicator = 1;

                        if(diceValue["value"] >= doubleValue)
                        {
                              multiplicator = 2;
                        }

                        successes = successes + (diceValue["count"] * multiplicator);
                  }
            });

            return successes;
      }

      function rollDices(count)
      {
            rolledDices = []

            // Roll
            for (var i = 0; i < count; i++) {
                  result = Math.floor(Math.random() * type) + 1 // 1-10 TODO Support multiple dices

                  jsonRes = { "index": i, "result": result };

                  rolledDices.push(jsonRes);
            }

            countDices = [];

            // Count
            rolledDices.forEach(element => 
            {
                  matching = countDices.filter(function (elem) {

                        if ((elem["value"] == element["result"])) {
                              return elem;
                        }

                  });

                  if (matching == null || matching.length == 0) {
                        countDices.push({ "value": element["result"], "count": 1 })
                        return;
                  }

                  matching[0]["count"] = matching[0]["count"] + 1;
            });

            countDices.sort(function (a, b) {
            return b["value"] < a["value"] ? 1
                  : b["value"] > a["value"] ? -1
                        : 0;
            })

            return countDices;
      }


</script>